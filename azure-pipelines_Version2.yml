# Copyright 2025 Cloudsmith Ltd
# Azure DevOps Pipeline: Cloudsmith OIDC Authentication Test with Python venv

trigger:
- main

pool:
  name: 'Default'

variables:
  CS_WORKSPACE: 'jtaylor-test'
  CS_REPO: 'python'
  CS_SERVICE_SLUG: 'az-service-principal-oidc'
  CS_VENV: '$(Pipeline.Workspace)/cs-venv'

steps:
- checkout: self

# setup Python venv for Cloudsmith CLI at a fixed location
- bash: |
    # create venv at pipeline workspace
    python3.12 -m venv "$CS_VENV"
    # upgrade pip in the venv, install CLI
    "$CS_VENV/bin/pip" install --upgrade pip
    "$CS_VENV/bin/pip" install cloudsmith-cli
    # add venv bin to PATH for rest of pipeline
    echo "##vso[task.prependpath]$CS_VENV/bin"
  displayName: 'Setup Python venv and install Cloudsmith CLI'

# Cloudsmith: Authenticate via OIDC using venv CLI
- task: CloudsmithCliSetupAndAuthenticate@1.1.1
  displayName: "Cloudsmith: Authenticate via OIDC"
  inputs:
    authMethod: 'oidc'
    oidcAuthOnly: false
    pipInstall: false          # CLI already installed in venv
    cliVersion: ''
    oidcNamespace: '$(CS_WORKSPACE)'
    oidcServiceSlug: '$(CS_SERVICE_SLUG)'

# use latest Python available on agent
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
  displayName: "Use latest Python"

# verify authentication with Cloudsmith CLI in venv
- bash: |
    set -eo pipefail
    cloudsmith whoami
  displayName: "Cloudsmith CLI: whoami (verify OIDC auth)"
